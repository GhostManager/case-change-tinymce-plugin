/**
 * @copyright ©Melqui Brito. All rights reserved.
 * @author Melqui Brito
 * @version 1.2.0 (2020-03-08)
 * @description Tinymce custom plugin for changing text case.
 */

!function(){tinymce.PluginManager.add("case",function(t){const e="Change Case",n="lowercase",o="UPPERCASE",s="Sentence case",a="Title Case",r=["at","by","in","of","on","up","to","en","re","vs","but","off","out","via","bar","mid","per","pro","qua","til","from","into","unto","with","amid","anit","atop","down","less","like","near","over","past","plus","sans","save","than","thru","till","upon","for","and","nor","but","or","yet","so","an","a","some","the"];var i=function(){let e=t.getParam("title_case_excepions");if(e){if(Array.isArray(e))return e;if("string"==typeof e)return e.replace(/(\s{1,})/g,"?").trim().split("?")}return r}();String.prototype.toSentenceCase=function(){return this.toLowerCase().replace(/(^\s*\w|[\.\!\?]\s*\w)/g,function(t){return t.toUpperCase()})},String.prototype.toTitleCase=function(){return(t=>{let e=t.split(".");for(let t in e){let n=e[t].split(" "),o=0;if(e[t].trim().replace(/(^\s+|\s+$)/g,"").length>0){for(;o<n.length;o++){let t=!1;for(let e=0;e<n[o].length;e++)if(n[o][e].match(/([a-z'áàâãäéèêëíìîïóòôõöúùûü])/i)){n[o]=n[o][e].toUpperCase()+n[o].slice(e+1),t=!0;break}if(t)break}for(;o<n.length;o++)if(-1===i.indexOf(n[o]))for(let t=0;t<n[o].length;t++)if(n[o][t].match(/([a-z'áàâãäéèêëíìîïóòôõöúùûü])/i)){n[o]=n[o][t].toUpperCase()+n[o].slice(t+1);break}e[t]=n.join(" ")}}return e.join(".")})(this.toLowerCase())},String.prototype.apply=function(t){switch(t){case n:return this.toLowerCase();case o:return this.toUpperCase();case s:return this.toSentenceCase();case a:return this.toTitleCase();default:return this}};const c=function(t,e,n){console.log(n),n.first&&n.last?t.textContent=t.textContent.slice(0,n.startOffset)+t.textContent.slice(n.startOffset,n.endOffset).apply(e)+t.textContent.slice(n.endOffset):n.first&&!n.last?t.textContent=t.textContent.slice(0,n.startOffset)+t.textContent.slice(n.startOffset).apply(e):!n.first&&n.last?t.textContent=t.textContent.slice(0,n.endOffset).apply(e)+t.textContent.slice(n.endOffset):t.textContent=t.textContent.apply(e)},l=function(e){let n=t.selection.getRng(),o=t.selection.getBookmark(2,!0),s=new tinymce.dom.TreeWalker(n.startContainer),a=n.startContainer,r=n.endContainer,i=n.startOffset,l=n.endOffset,f=s.current();console.log(n);do{if("#text"===f.nodeName&&(console.log(f),c(f,e,{first:f===a,last:f===r,startOffset:i,endOffset:l})),f===r)break;f=s.next()}while(f);t.save(),t.isNotDirty=!0,t.focus(),t.selection.moveToBookmark(o)},f=function(){return[{type:"menuitem",text:n,onAction:()=>l(n)},{type:"menuitem",text:o,onAction:()=>l(o)},{type:"menuitem",text:s,onAction:()=>l(s)},{type:"menuitem",text:a,onAction:()=>l(a)}]};return t.ui.registry.addMenuButton("case",{icon:"change-case",tooltip:e,fetch:function(t){t(f())}}),t.ui.registry.addNestedMenuItem("case",{text:e,getSubmenuItems:()=>f()}),t.addCommand("mceLowerCase",()=>l(n)),t.addCommand("mceUpperCase",()=>l(o)),t.addCommand("mceSentenceCase",()=>l(s)),t.addCommand("mceTitleCase",()=>l(a)),{getMetadata:function(){return{name:"Case",url:"https://github.com/melquibrito/Case-change-tinymce-plugin"}}}})}();
