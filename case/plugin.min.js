/**
 * @copyright Â©Melqui Brito. All rights reserved.
 * @author Melqui Brito
 * @version 1.0.0 (2020-02-29)
 * @description Tinymce custom plugin for changing text case. It provides a tinymce menu button which can be displayed on tinymce's toolbar with the following menu items: "lower case", "UPPER CASE", "Sentence case", and "Title Case".
 */

(function () {
    tinymce.PluginManager.add('case',
        function (editor) {

            const strings = {
                TOOLNAME: 'Change Case',
                LOWERCASE: 'lowercase',
                UPPERCASE: 'UPPERCASE',
                SENTENCECASE: 'Sentence case',
                TITLECASE: 'Title Case'
            }

            /*
             * Appending new functions to String.prototype...
             */
            String.prototype.toSentenceCase = function () {
                return this.toLowerCase().replace(/(^\s*\w|[\.\!\?]\s*\w)/g, function (c) {
                    return c.toUpperCase()
                });
            }
            String.prototype.toTitleCase = function () {
                return this.toLowerCase().replace(/(^|[^a-z'])([a-z'])/g, function (m, p1, p2) {
                    return p1 + p2.toUpperCase();
                });
            }
            
            /*
             * Helpers
             */
            const getSelectedText = function () {
                return editor.dom.decode(editor.selection.getContent());
            }

            const perform = function (func) {
                result = func();
                editor.selection.setContent(result);
                editor.save();
                editor.isNotDirty = true;
            }

            /*
             * Plugin Methods
             */
            const lowerCase = function () {
                return function () {
                    perform(() => {
                        return getSelectedText().toLowerCase();
                    })
                }
            }
            const upperCase = function () {
                return function () {
                    perform(() => {
                        return getSelectedText().toUpperCase();
                    })
                }
            }
            const sentenceCase = function () {
                return function () {
                    perform(() => {
                        return getSelectedText().toSentenceCase();
                    })
                }
            }
            const titleCase = function () {
                return function () {
                    perform(() => {
                        return getSelectedText().toTitleCase();
                    })
                }
            }

            
            /*
             * Element Builders 
             */
            const getMenuItems = function () {
                return [
                    {
                        type: "menuitem",
                        text: strings.LOWERCASE,
                        onAction: lowerCase()
                    },
                    {
                        type: "menuitem",
                        text: strings.UPPERCASE,
                        onAction: upperCase()
                    },
                    {
                        type: "menuitem",
                        text: strings.SENTENCECASE,
                        onAction: sentenceCase()
                    },
                    {
                        type: "menuitem",
                        text: strings.TITLECASE,
                        onAction: titleCase()
                    }
                ]
            }
            
            const getMenuButton = function () {
                return {
                    icon: 'change-case',
                    tooltip: strings.TOOLNAME,
                    fetch: function (callback) {
                        const items = getMenuItems();
                        callback(items);
                    }
                }
            }

            const getNestedMenuItem = function () {
                return {
                    text: strings.TOOLNAME,
                    getSubmenuItems: () => {
                        return getMenuItems();
                    }
                }
            }

            /*
             * Creating tinymce elements so that they can be invoked in tinymce init function...
             */
            editor.ui.registry.addMenuButton('case', getMenuButton());
            editor.ui.registry.addNestedMenuItem('case', getNestedMenuItem());

            /*
             * Metadata returned so that tinymce help plugin can make use of it.
             */
            return {
                getMetadata: function () {
                    return {
                        name: "Case",
                        url: "https://github.com/melquibrito/Case-change-tinymce-plugin"
                    }
                }
            }
        }
    );
})();
